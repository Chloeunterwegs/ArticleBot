/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/markmap-view@0.17.0/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{Hook as st,getId as at,debounce as lt,addClass as ct,walkTree as T,childSelector as C,noop as M}from"markmap-common";import{loadCSS as Ce,loadJS as we}from"markmap-common";import{scaleOrdinal as V,schemeCategory10 as ht,zoomTransform as A,select as dt,zoom as ut,linkHorizontal as pt,min as H,max as L,zoomIdentity as mt,minIndex as ft}from"d3";const K=typeof navigator<"u"&&navigator.userAgent.includes("Macintosh"),gt=V(ht),P={autoFit:!1,color:t=>{var e;return gt(`${(null==(e=t.state)?void 0:e.path)||""}`)},duration:500,embedGlobalCSS:!0,fitRatio:.95,maxWidth:0,nodeMinHeight:16,paddingX:8,scrollForPan:K,spacingHorizontal:80,spacingVertical:5,initialExpandLevel:-1,zoom:!0,pan:!0,toggleRecursively:!1};function Se(t){const e={},r={...t},{color:n,colorFreezeLevel:a}=r;if(1===(null==n?void 0:n.length)){const t=n[0];e.color=()=>t}else if(null!=n&&n.length){const t=V(n);e.color=e=>t(`${e.state.path}`)}if(a){const t=e.color||P.color;e.color=e=>(e={...e,state:{...e.state,path:e.state.path.split(".").slice(0,a).join(".")}},t(e))}return["duration","maxWidth","initialExpandLevel"].forEach((t=>{const n=r[t];"number"==typeof n&&(e[t]=n)})),["zoom","pan"].forEach((t=>{const n=r[t];null!=n&&(e[t]=!!n)})),e
/*! @gera2ld/jsx-dom v2.2.2 | ISC License */}const U=1,G=2,xt="http://www.w3.org/2000/svg",_="http://www.w3.org/1999/xlink",yt={show:_,actuate:_,href:_},kt=t=>"string"==typeof t||"number"==typeof t,vt=t=>1===(null==t?void 0:t.vtype),St=t=>2===(null==t?void 0:t.vtype);function j(t,e){let r;if("string"==typeof t)r=1;else{if("function"!=typeof t)throw new Error("Invalid VNode type");r=2}return{vtype:r,type:t,props:e}}function bt(t){return t.children}const zt={isSvg:!1};function I(t,e){Array.isArray(e)||(e=[e]),(e=e.filter(Boolean)).length&&t.append(...e)}function Et(t,e,r){for(const n in e)if("key"!==n&&"children"!==n&&"ref"!==n)if("dangerouslySetInnerHTML"===n)t.innerHTML=e[n].__html;else if("innerHTML"===n||"textContent"===n||"innerText"===n||"value"===n&&["textarea","select"].includes(t.tagName)){const r=e[n];null!=r&&(t[n]=r)}else n.startsWith("on")?t[n.toLowerCase()]=e[n]:wt(t,n,e[n],r.isSvg)}const Ct={className:"class",labelFor:"for"};function wt(t,e,r,n){if(e=Ct[e]||e,!0===r)t.setAttribute(e,"");else if(!1===r)t.removeAttribute(e);else{const a=n?yt[e]:void 0;void 0!==a?t.setAttributeNS(a,e,r):t.setAttribute(e,r)}}function Xt(t){return t.reduce(((t,e)=>t.concat(e)),[])}function $(t,e){return Array.isArray(t)?Xt(t.map((t=>$(t,e)))):B(t,e)}function B(t,e=zt){if(null==t||"boolean"==typeof t)return null;if(t instanceof Node)return t;if(St(t)){const{type:r,props:n}=t;if(r===bt){const t=document.createDocumentFragment();if(n.children){I(t,$(n.children,e))}return t}return B(r(n),e)}if(kt(t))return document.createTextNode(`${t}`);if(vt(t)){let r;const{type:n,props:a}=t;if(!e.isSvg&&"svg"===n&&(e=Object.assign({},e,{isSvg:!0})),r=e.isSvg?document.createElementNS(xt,n):document.createElement(n),Et(r,a,e),a.children){let t=e;e.isSvg&&"foreignObject"===n&&(t=Object.assign({},t,{isSvg:!1}));const i=$(a.children,t);null!=i&&I(r,i)}const{ref:i}=a;return"function"==typeof i&&i(r),r}throw new Error("mount: Invalid Vnode!")}function O(t){return B(t)}function jt(t){var e=0,r=t.children,n=r&&r.length;if(n)for(;--n>=0;)e+=r[n].value;else e=1;t.value=e}function Nt(){return this.eachAfter(jt)}function Rt(t){var e,r,n,a,i=this,o=[i];do{for(e=o.reverse(),o=[];i=e.pop();)if(t(i),r=i.children)for(n=0,a=r.length;n<a;++n)o.push(r[n])}while(o.length);return this}function Tt(t){for(var e,r,n=this,a=[n];n=a.pop();)if(t(n),e=n.children)for(r=e.length-1;r>=0;--r)a.push(e[r]);return this}function Mt(t){for(var e,r,n,a=this,i=[a],o=[];a=i.pop();)if(o.push(a),e=a.children)for(r=0,n=e.length;r<n;++r)i.push(e[r]);for(;a=o.pop();)t(a);return this}function At(t){return this.eachAfter((function(e){for(var r=+t(e.data)||0,n=e.children,a=n&&n.length;--a>=0;)r+=n[a].value;e.value=r}))}function _t(t){return this.eachBefore((function(e){e.children&&e.children.sort(t)}))}function Ot(t){for(var e=this,r=Dt(e,t),n=[e];e!==r;)e=e.parent,n.push(e);for(var a=n.length;t!==r;)n.splice(a,0,t),t=t.parent;return n}function Dt(t,e){if(t===e)return t;var r=t.ancestors(),n=e.ancestors(),a=null;for(t=r.pop(),e=n.pop();t===e;)a=t,t=r.pop(),e=n.pop();return a}function $t(){for(var t=this,e=[t];t=t.parent;)e.push(t);return e}function Bt(){var t=[];return this.each((function(e){t.push(e)})),t}function Ft(){var t=[];return this.eachBefore((function(e){e.children||t.push(e)})),t}function Ht(){var t=this,e=[];return t.each((function(r){r!==t&&e.push({source:r.parent,target:r})})),e}function F(t,e){var r,n,a,i,o,s=new N(t),l=+t.value&&(s.value=t.value),h=[s];for(null==e&&(e=It);r=h.pop();)if(l&&(r.value=+r.data.value),(a=e(r.data))&&(o=a.length))for(r.children=new Array(o),i=o-1;i>=0;--i)h.push(n=r.children[i]=new N(a[i])),n.parent=r,n.depth=r.depth+1;return s.eachBefore(Yt)}function Lt(){return F(this).eachBefore(Wt)}function It(t){return t.children}function Wt(t){t.data=t.data.data}function Yt(t){var e=0;do{t.height=e}while((t=t.parent)&&t.height<++e)}function N(t){this.data=t,this.depth=this.height=0,this.parent=null}N.prototype=F.prototype={constructor:N,count:Nt,each:Rt,eachAfter:Mt,eachBefore:Tt,sum:At,sort:_t,path:Ot,ancestors:$t,descendants:Bt,leaves:Ft,links:Ht,copy:Lt};const Vt="d3-flextree",Kt="2.1.2",Pt="build/d3-flextree.js",Ut="index",Gt={name:"Chris Maloney",url:"http://chrismaloney.org"},Zt="Flexible tree layout algorithm that allows for variable node sizes.",qt=["d3","d3-module","layout","tree","hierarchy","d3-hierarchy","plugin","d3-plugin","infovis","visualization","2d"],Jt="https://github.com/klortho/d3-flextree",Qt="WTFPL",te={type:"git",url:"https://github.com/klortho/d3-flextree.git"},ee={clean:"rm -rf build demo test","build:demo":"rollup -c --environment BUILD:demo","build:dev":"rollup -c --environment BUILD:dev","build:prod":"rollup -c --environment BUILD:prod","build:test":"rollup -c --environment BUILD:test",build:"rollup -c",lint:"eslint index.js src","test:main":"node test/bundle.js","test:browser":"node test/browser-tests.js",test:"npm-run-all test:*",prepare:"npm-run-all clean build lint test"},ne={"d3-hierarchy":"^1.1.5"},re={"babel-plugin-external-helpers":"^6.22.0","babel-preset-es2015-rollup":"^3.0.0",d3:"^4.13.0","d3-selection-multi":"^1.0.1",eslint:"^4.19.1",jsdom:"^11.6.2","npm-run-all":"^4.1.2",rollup:"^0.55.3","rollup-plugin-babel":"^2.7.1","rollup-plugin-commonjs":"^8.0.2","rollup-plugin-copy":"^0.2.3","rollup-plugin-json":"^2.3.0","rollup-plugin-node-resolve":"^3.0.2","rollup-plugin-uglify":"^3.0.0","uglify-es":"^3.3.9"},ie={name:Vt,version:Kt,main:Pt,module:Ut,"jsnext:main":"index",author:Gt,description:Zt,keywords:qt,homepage:Jt,license:Qt,repository:te,scripts:ee,dependencies:ne,devDependencies:re},{version:oe}=ie,se=Object.freeze({children:t=>t.children,nodeSize:t=>t.data.size,spacing:0});function q(t){const e=Object.assign({},se,t);function r(t){const r=e[t];return"function"==typeof r?r:()=>r}function n(t){const e=i(function(){const t=a(),e=r("nodeSize"),n=r("spacing");return class extends t{constructor(t){super(t),Object.assign(this,{x:0,y:0,relX:0,prelim:0,shift:0,change:0,lExt:this,lExtRelX:0,lThr:null,rExt:this,rExtRelX:0,rThr:null})}get size(){return e(this.data)}spacing(t){return n(this.data,t.data)}get x(){return this.data.x}set x(t){this.data.x=t}get y(){return this.data.y}set y(t){this.data.y=t}update(){return J(this),Q(this),this}}}(),t,(t=>t.children));return e.update(),e.data}function a(){const t=r("nodeSize"),e=r("spacing");return class r extends F.prototype.constructor{constructor(t){super(t)}copy(){const t=i(this.constructor,this,(t=>t.children));return t.each((t=>t.data=t.data.data)),t}get size(){return t(this)}spacing(t){return e(this,t)}get nodes(){return this.descendants()}get xSize(){return this.size[0]}get ySize(){return this.size[1]}get top(){return this.y}get bottom(){return this.y+this.ySize}get left(){return this.x-this.xSize/2}get right(){return this.x+this.xSize/2}get root(){const t=this.ancestors();return t[t.length-1]}get numChildren(){return this.hasChildren?this.children.length:0}get hasChildren(){return!this.noChildren}get noChildren(){return null===this.children}get firstChild(){return this.hasChildren?this.children[0]:null}get lastChild(){return this.hasChildren?this.children[this.numChildren-1]:null}get extents(){return(this.children||[]).reduce(((t,e)=>r.maxExtents(t,e.extents)),this.nodeExtents)}get nodeExtents(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}static maxExtents(t,e){return{top:Math.min(t.top,e.top),bottom:Math.max(t.bottom,e.bottom),left:Math.min(t.left,e.left),right:Math.max(t.right,e.right)}}}}function i(t,e,r){const n=(e,a)=>{const i=new t(e);Object.assign(i,{parent:a,depth:null===a?0:a.depth+1,height:0,length:1});const o=r(e)||[];return i.children=0===o.length?null:o.map((t=>n(t,i))),i.children&&Object.assign(i,i.children.reduce(((t,e)=>({height:Math.max(t.height,e.height+1),length:t.length+e.length})),i)),i};return n(e,null)}return Object.assign(n,{nodeSize(t){return arguments.length?(e.nodeSize=t,n):e.nodeSize},spacing(t){return arguments.length?(e.spacing=t,n):e.spacing},children(t){return arguments.length?(e.children=t,n):e.children},hierarchy(t,r){const n=typeof r>"u"?e.children:r;return i(a(),t,n)},dump(t){const e=r("nodeSize"),n=t=>r=>{const a=t+"  ",i=t+"    ",{x:o,y:s}=r,l=e(r),h=r.children||[],c=0===h.length?" ":`,${a}children: [${i}${h.map(n(i)).join(i)}${a}],${t}`;return`{ size: [${l.join(", ")}],${a}x: ${o}, y: ${s}${c}},`};return n("\n")(t)}}),n}q.version=oe;const J=(t,e=0)=>(t.y=e,(t.children||[]).reduce(((e,r)=>{const[n,a]=e;J(r,t.y+t.ySize);const i=(0===n?r.lExt:r.rExt).bottom;0!==n&&le(t,n,a);return[n+1,ge(i,n,a)]}),[0,null]),ae(t),fe(t),t),Q=(t,e,r)=>{typeof e>"u"&&(e=-t.relX-t.prelim,r=0);const n=e+t.relX;return t.relX=n+t.prelim-r,t.prelim=0,t.x=r+t.relX,(t.children||[]).forEach((e=>Q(e,n,t.x))),t},ae=t=>{(t.children||[]).reduce(((t,e)=>{const[r,n]=t,a=r+e.shift,i=n+a+e.change;return e.relX+=i,[a,i]}),[0,0])},le=(t,e,r)=>{const n=t.children[e-1],a=t.children[e];let i=n,o=n.relX,s=a,l=a.relX,h=!0;for(;i&&s;){i.bottom>r.lowY&&(r=r.next);const n=o+i.prelim-(l+s.prelim)+i.xSize/2+s.xSize/2+i.spacing(s);(n>0||n<0&&h)&&(l+=n,ce(a,n),he(t,e,r.index,n)),h=!1;const c=i.bottom,d=s.bottom;c<=d&&(i=ue(i),i&&(o+=i.relX)),c>=d&&(s=de(s),s&&(l+=s.relX))}!i&&s?pe(t,e,s,l):i&&!s&&me(t,e,i,o)},ce=(t,e)=>{t.relX+=e,t.lExtRelX+=e,t.rExtRelX+=e},he=(t,e,r,n)=>{const a=t.children[e],i=e-r;if(i>1){const e=n/i;t.children[r+1].shift+=e,a.shift-=e,a.change-=n-e}},de=t=>t.hasChildren?t.firstChild:t.lThr,ue=t=>t.hasChildren?t.lastChild:t.rThr,pe=(t,e,r,n)=>{const a=t.firstChild,i=a.lExt,o=t.children[e];i.lThr=r;const s=n-r.relX-a.lExtRelX;i.relX+=s,i.prelim-=s,a.lExt=o.lExt,a.lExtRelX=o.lExtRelX},me=(t,e,r,n)=>{const a=t.children[e],i=a.rExt,o=t.children[e-1];i.rThr=r;const s=n-r.relX-a.rExtRelX;i.relX+=s,i.prelim-=s,a.rExt=o.rExt,a.rExtRelX=o.rExtRelX},fe=t=>{if(t.hasChildren){const e=t.firstChild,r=t.lastChild,n=(e.prelim+e.relX-e.xSize/2+r.relX+r.prelim+r.xSize/2)/2;Object.assign(t,{prelim:n,lExt:e.lExt,lExtRelX:e.lExtRelX,rExt:r.rExt,rExtRelX:r.rExtRelX})}},ge=(t,e,r)=>{for(;null!==r&&t>=r.lowY;)r=r.next;return{lowY:t,index:e,next:r}},xe=".markmap-container{position:absolute;width:0;height:0;top:-100px;left:-100px;overflow:hidden}.markmap-container>.markmap-foreign{display:inline-block}.markmap-container>.markmap-foreign>div:last-child,.markmap-container>.markmap-foreign>div:last-child :not(pre){white-space:nowrap}.markmap-container>.markmap-foreign>div:last-child code{white-space:inherit}",tt=".markmap{--markmap-max-width: none;--markmap-a-color: #0097e6;--markmap-a-hover-color: #00a8ff;--markmap-code-bg: #f0f0f0;--markmap-code-color: #555;--markmap-highlight-bg: #ffeaa7;--markmap-table-border: 1px solid currentColor;--markmap-font: 300 16px/20px sans-serif;--markmap-circle-open-bg: #fff;--markmap-text-color: #333;font:var(--markmap-font);color:var(--markmap-text-color)}.markmap-link{fill:none}.markmap-node>circle{cursor:pointer}.markmap-foreign{display:inline-block}.markmap-foreign p{margin:0}.markmap-foreign a{color:var(--markmap-a-color)}.markmap-foreign a:hover{color:var(--markmap-a-hover-color)}.markmap-foreign code{padding:.25em;font-size:calc(1em - 2px);color:var(--markmap-code-color);background-color:var(--markmap-code-bg);border-radius:2px}.markmap-foreign pre{margin:0}.markmap-foreign pre>code{display:block}.markmap-foreign del{text-decoration:line-through}.markmap-foreign em{font-style:italic}.markmap-foreign strong{font-weight:700}.markmap-foreign mark{background:var(--markmap-highlight-bg)}.markmap-foreign table,.markmap-foreign th,.markmap-foreign td{border-collapse:collapse;border:var(--markmap-table-border)}.markmap-foreign img{display:inline-block}.markmap-foreign svg{fill:currentColor}.markmap-foreign-testing-max{max-width:var(--markmap-max-width)}.markmap-foreign-testing-max img{max-width:var(--markmap-max-width);max-height:none}.markmap-dark .markmap{--markmap-code-bg: #1a1b26;--markmap-code-color: #ddd;--markmap-circle-open-bg: #444;--markmap-text-color: #eee}",be=tt;function W(t){const e=t.data;return Math.max(4-2*e.state.depth,1.5)}function Y(t,e){return t[ft(t,e)]}function D(t){t.stopPropagation()}const ye=new st;class et{constructor(t,e){this.options=P,this.revokers=[],this.imgCache={},this.handleZoom=t=>{const{transform:e}=t;this.g.attr("transform",e)},this.handlePan=t=>{t.preventDefault();const e=A(this.svg.node()),r=e.translate(-t.deltaX/e.k,-t.deltaY/e.k);this.svg.call(this.zoom.transform,r)},this.handleClick=(t,e)=>{let r=this.options.toggleRecursively;(K?t.metaKey:t.ctrlKey)&&(r=!r),this.toggleNode(e.data,r)},this.svg=t.datum?t:dt(t),this.styleNode=this.svg.append("style"),this.zoom=ut().filter((t=>this.options.scrollForPan&&"wheel"===t.type?t.ctrlKey&&!t.button:!(t.ctrlKey&&"wheel"!==t.type||t.button))).on("zoom",this.handleZoom),this.setOptions(e),this.state={id:this.options.id||this.svg.attr("id")||at(),minX:0,maxX:0,minY:0,maxY:0},this.g=this.svg.append("g"),this.debouncedRefresh=lt((()=>this.setData()),200),this.revokers.push(ye.tap((()=>{this.setData()})))}getStyleContent(){const{style:t}=this.options,{id:e}=this.state,r="function"==typeof t?t(e):"";return[this.options.embedGlobalCSS&&tt,r].filter(Boolean).join("\n")}updateStyle(){this.svg.attr("class",ct(this.svg.attr("class"),"markmap",this.state.id));const t=this.getStyleContent();this.styleNode.text(t)}toggleNode(t,e=!1){var r,n;const a=null!=(r=t.payload)&&r.fold?0:1;e?T(t,((t,e)=>{t.payload={...t.payload,fold:a},e()})):t.payload={...t.payload,fold:null!=(n=t.payload)&&n.fold?0:1},this.renderData(t)}initializeData(t){let e=0;const{color:r,nodeMinHeight:n,maxWidth:a,initialExpandLevel:i}=this.options,{id:o}=this.state,s=O(j("div",{className:`markmap-container markmap ${o}-g`})),l=O(j("style",{children:[this.getStyleContent(),xe].join("\n")}));document.body.append(s,l);const h=a?`--markmap-max-width: ${a}px`:"";let c=0,d=0;T(t,((t,n,a)=>{var o,l,p;d+=1,t.children=null==(o=t.children)?void 0:o.map((t=>({...t}))),e+=1;const u=O(j("div",{className:"markmap-foreign markmap-foreign-testing-max",style:h,children:j("div",{dangerouslySetInnerHTML:{__html:t.content}})}));s.append(u),t.state={...t.state,depth:d,id:e,el:u.firstChild},t.state.path=[null==(l=null==a?void 0:a.state)?void 0:l.path,t.state.id].filter(Boolean).join("."),r(t);const m=2===(null==(p=t.payload)?void 0:p.fold);m?c+=1:(c||i>=0&&t.state.depth>=i)&&(t.payload={...t.payload,fold:1}),n(),m&&(c-=1),d-=1}));const p=Array.from(s.childNodes).map((t=>t.firstChild));this._checkImages(s),p.forEach((t=>{var e;null==(e=t.parentNode)||e.append(t.cloneNode(!0))})),T(t,((t,e,r)=>{var a;const i=t.state,o=i.el.getBoundingClientRect();t.content=i.el.innerHTML,i.size=[Math.ceil(o.width)+1,Math.max(Math.ceil(o.height),n)],i.key=[null==(a=null==r?void 0:r.state)?void 0:a.id,i.id].filter(Boolean).join(".")+t.content,e()})),s.remove(),l.remove()}_checkImages(t){t.querySelectorAll("img").forEach((t=>{if(t.width)return;const e=this.imgCache[t.src];null!=e&&e[0]?[t.width,t.height]=e:e||this._loadImage(t.src)}))}_loadImage(t){this.imgCache[t]=[0,0];const e=new Image;e.src=t,e.onload=()=>{this.imgCache[t]=[e.naturalWidth,e.naturalHeight],this.debouncedRefresh()}}setOptions(t){this.options={...this.options,...t},this.options.zoom?this.svg.call(this.zoom):this.svg.on(".zoom",null),this.options.pan?this.svg.on("wheel",this.handlePan):this.svg.on("wheel",null)}setData(t,e){e&&this.setOptions(e),t&&(this.state.data=t),this.state.data&&(this.initializeData(this.state.data),this.updateStyle(),this.renderData())}renderData(t){if(!this.state.data)return;const{spacingHorizontal:e,paddingX:r,spacingVertical:n,autoFit:a,color:i}=this.options,o=q({}).children((t=>{var e;if(null==(e=t.payload)||!e.fold)return t.children})).nodeSize((t=>{const[n,a]=t.data.state.size;return[a,n+(n?2*r:0)+e]})).spacing(((t,e)=>t.parent===e.parent?n:2*n)),s=o.hierarchy(this.state.data);o(s);const l=s.descendants().reverse(),h=s.links(),c=pt(),d=H(l,(t=>t.x-t.xSize/2)),p=L(l,(t=>t.x+t.xSize/2)),u=H(l,(t=>t.y)),m=L(l,(t=>t.y+t.ySize-e));Object.assign(this.state,{minX:d,maxX:p,minY:u,maxY:m}),a&&this.fit();const g=t&&l.find((e=>e.data===t))||s,f=g.data.state.x0??g.x,x=g.data.state.y0??g.y,y=this.g.selectAll(C("g")).data(l,(t=>t.data.state.key)),v=y.enter().append("g").attr("data-depth",(t=>t.data.state.depth)).attr("data-path",(t=>t.data.state.path)).attr("transform",(t=>`translate(${x+g.ySize-t.ySize},${f+g.xSize/2-t.xSize})`)),k=this.transition(y.exit());k.select("line").attr("x1",(t=>t.ySize-e)).attr("x2",(t=>t.ySize-e)),k.select("foreignObject").style("opacity",0),k.attr("transform",(t=>`translate(${g.y+g.ySize-t.ySize},${g.x+g.xSize/2-t.xSize})`)).remove();const b=y.merge(v).attr("class",(t=>{var e;return["markmap-node",(null==(e=t.data.payload)?void 0:e.fold)&&"markmap-fold"].filter(Boolean).join(" ")}));this.transition(b).attr("transform",(t=>`translate(${t.y},${t.x-t.xSize/2})`));const z=b.selectAll(C("line")).data((t=>[t]),(t=>t.data.state.key)).join((t=>t.append("line").attr("x1",(t=>t.ySize-e)).attr("x2",(t=>t.ySize-e))),(t=>t),(t=>t.remove()));this.transition(z).attr("x1",-1).attr("x2",(t=>t.ySize-e+2)).attr("y1",(t=>t.xSize)).attr("y2",(t=>t.xSize)).attr("stroke",(t=>i(t.data))).attr("stroke-width",W);const S=b.selectAll(C("circle")).data((t=>{var e;return null!=(e=t.data.children)&&e.length?[t]:[]}),(t=>t.data.state.key)).join((t=>t.append("circle").attr("stroke-width","1.5").attr("cx",(t=>t.ySize-e)).attr("cy",(t=>t.xSize)).attr("r",0).on("click",((t,e)=>this.handleClick(t,e))).on("mousedown",D)),(t=>t),(t=>t.remove()));this.transition(S).attr("r",6).attr("cx",(t=>t.ySize-e)).attr("cy",(t=>t.xSize)).attr("stroke",(t=>i(t.data))).attr("fill",(t=>{var e;return null!=(e=t.data.payload)&&e.fold&&t.data.children?i(t.data):"var(--markmap-circle-open-bg)"}));const w=b.selectAll(C("foreignObject")).data((t=>[t]),(t=>t.data.state.key)).join((t=>{const e=t.append("foreignObject").attr("class","markmap-foreign").attr("x",r).attr("y",0).style("opacity",0).on("mousedown",D).on("dblclick",D);return e.append("xhtml:div").select((function(t){const e=t.data.state.el.cloneNode(!0);return this.replaceWith(e),e})).attr("xmlns","http://www.w3.org/1999/xhtml"),e}),(t=>t),(t=>t.remove())).attr("width",(t=>Math.max(0,t.ySize-e-2*r))).attr("height",(t=>t.xSize));this.transition(w).style("opacity",1);const E=this.g.selectAll(C("path")).data(h,(t=>t.target.data.state.key)).join((t=>{const r=[x+g.ySize-e,f+g.xSize/2];return t.insert("path","g").attr("class","markmap-link").attr("data-depth",(t=>t.target.data.state.depth)).attr("data-path",(t=>t.target.data.state.path)).attr("d",c({source:r,target:r}))}),(t=>t),(t=>{const r=[g.y+g.ySize-e,g.x+g.xSize/2];return this.transition(t).attr("d",c({source:r,target:r})).remove()}));this.transition(E).attr("stroke",(t=>i(t.target.data))).attr("stroke-width",(t=>W(t.target))).attr("d",(t=>{const r=t.source,n=t.target,a=[r.y+r.ySize-e,r.x+r.xSize/2],i=[n.y,n.x+n.xSize/2];return c({source:a,target:i})})),l.forEach((t=>{t.data.state.x0=t.x,t.data.state.y0=t.y}))}transition(t){const{duration:e}=this.options;return t.transition().duration(e)}async fit(){const t=this.svg.node(),{width:e,height:r}=t.getBoundingClientRect(),{fitRatio:n}=this.options,{minX:a,maxX:i,minY:o,maxY:s}=this.state,l=s-o,h=i-a,c=Math.min(e/l*n,r/h*n,2),d=mt.translate((e-l*c)/2-o*c,(r-h*c)/2-a*c).scale(c);return this.transition(this.svg).call(this.zoom.transform,d).end().catch(M)}findElement(t){let e;return this.g.selectAll(C("g")).each((function(r){r.data===t&&(e={data:r,g:this})})),e}async ensureView(t,e){var r;const n=null==(r=this.findElement(t))?void 0:r.data;if(!n)return;const a=this.svg.node(),{spacingHorizontal:i}=this.options,o=a.getBoundingClientRect(),s=A(a),[l,h]=[n.y,n.y+n.ySize-i+2].map((t=>t*s.k+s.x)),[c,d]=[n.x-n.xSize/2,n.x+n.xSize/2].map((t=>t*s.k+s.y)),p={left:0,right:0,top:0,bottom:0,...e},u=[p.left-l,o.width-p.right-h],m=[p.top-c,o.height-p.bottom-d],g=u[0]*u[1]>0?Y(u,Math.abs)/s.k:0,f=m[0]*m[1]>0?Y(m,Math.abs)/s.k:0;if(g||f){const t=s.translate(g,f);return this.transition(this.svg).call(this.zoom.transform,t).end().catch(M)}}async rescale(t){const e=this.svg.node(),{width:r,height:n}=e.getBoundingClientRect(),a=r/2,i=n/2,o=A(e),s=o.translate((a-o.x)*(1-t)/o.k,(i-o.y)*(1-t)/o.k).scale(t);return this.transition(this.svg).call(this.zoom.transform,s).end().catch(M)}destroy(){this.svg.on(".zoom",null),this.svg.html(null),this.revokers.forEach((t=>{t()}))}static create(t,e,r=null){const n=new et(t,e);return r&&(n.setData(r),n.fit()),n}}export{et as Markmap,gt as defaultColorFn,P as defaultOptions,Se as deriveOptions,be as globalCSS,K as isMacintosh,Ce as loadCSS,we as loadJS,ye as refreshHook};
//# sourceMappingURL=/sm/7f5c8a295e7487189c608e1da6f5e29f9be733904e58c3cb253dc42dc8a81727.map
// 这里是 markmap 库的压缩代码 (很长的一行代码)


!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).markmap={})}(this,(function(t){"use strict";
    //... (这里是很长的压缩代码) ...
    }));

// 然后,保留我们原有的应用逻辑
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === "startProcessing") {
    processArticle(request.content, request.url, request.title)
      .then(() => sendResponse({success: true}))
      .catch((error) => {
        console.error(error);
        sendResponse({success: false, error: error.message});
      });
    return true; // 保持消息通道开放
  }
});

async function processArticle(content, url, title) {
  // 1. 调用本地大模型进行总结
  const summary = await callLocalModel(content, "summarize");
  
  // 2. 生成标签
  const tags = await callLocalModel(content, "generateTags");
  
  // 3. 生成Markmap
  const markmap = await generateMarkmap(summary);
  
  // 4. 创建MD文件
  const mdContent = createMdContent(title, url, tags, markmap, summary);
  
  // 5. 同步到Obsidian
  await syncToObsidian(mdContent);
}

async function callLocalModel(content, task) {
  return new Promise((resolve, reject) => {
    chrome.runtime.sendNativeMessage(
      'local_ai_model',
      { content, task },
      (response) => {
        if (chrome.runtime.lastError) {
          reject(chrome.runtime.lastError);
        } else {
          resolve(response.result);
        }
      }
    );
  });
}

async function generateMarkmap(summary) {
  const { Markmap } = window.markmap;
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('width', '800');
  svg.setAttribute('height', '600');
  
  const mm = Markmap.create(svg);
  const root = transformSummaryToMarkmapData(summary);
  mm.setData(root);
  mm.fit();
  
  return svg.outerHTML;
}

function transformSummaryToMarkmapData(summary) {
  // 这里需要实现将summary转换为markmap数据结构的逻辑
  // 示例:
  return {
    content: '文章总结',
    children: [
      { content: '主要观点1' },
      { content: '主要观点2' },
      { content: '主要观点3' },
    ]
  };
}

function createMdContent(title, url, tags, markmap, summary) {
  return `
# ${title}

URL: ${url}

标签: ${tags.join(', ')}

## 思维导图

${markmap}

## 总结

${summary}
  `;
}

async function syncToObsidian(content) {
  return ObsidianSync.syncNote(content);
}